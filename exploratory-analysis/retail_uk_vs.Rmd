---
title: "UK Sales"
author: "Viviane Sanchez"
date: "11/7/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message = FALSE, warning = FALSE, 
                      fig.retina = 2 ,fig.height=5, fig.width=10)


```

## R Markdown

```{r eval = TRUE, tidy = FALSE}

library(skimr)
library(ggrepel)
library(factoextra)
library(zoo)
library(clue)
library(readxl)
library(janitor)
library(inspectdf)
library(knitr)
library(arules)
library(arulesViz)
library(tidytext)
library(lubridate)
library(tidymodels)
library(tidyverse)
library(conflicted)
library(highcharter)

conflict_prefer("filter", "dplyr")

theme_set(theme_economist())
theme_update(text = element_text(family = "Open Sans"),
             plot.title = element_text(face = "bold", size = 23,
                                       color = "#1d3752"),
             legend.position = "bottom")

options(digits=4)

```

## Pré-processamento

Preparação da base para o formato utilizado pelo pacote `arules`

```{r pressure, echo=FALSE}

retail_raw <- read_csv("data/retail.csv")

retail <- retail_raw %>% 
  clean_names() %>%
  mutate(description = str_replace(description, ",","|")) %>% 
  glimpse

```

## Filtro

```{r}

tickets <- retail %>% 
  filter(country == "United Kingdom") %>% 
  group_by(invoice_no) %>%
  summarise(Quantidade = sum(quantity), Receita = sum(total_revenue)) %>% 
  arrange(desc(Receita))

foras <- tickets %>% 
  filter(Receita > 50000) %>%
  select(invoice_no) %>% unique() %>% 
  pull(invoice_no)

clientes <- retail %>% 
  group_by(customer_id,invoice_no) %>%
  summarise(Tkt = length(unique(invoice_no)) ,Qty = sum(quantity), Net = sum(total_revenue)) %>%
  group_by(customer_id) %>%
  summarise(Tkt = sum(Tkt) ,Qty = sum(Qty), Net = sum(Net)) %>%
  arrange(desc(Net))

foras2 <- clientes %>% 
  filter(Tkt > 100) %>% 
  pull(customer_id)

rt_uk <- retail %>% 
  filter(country == "United Kingdom") %>% 
  filter(!invoice_no %in% foras) %>% 
  filter(!customer_id %in% foras2)

```


## Preparação para Basket Analysis
```{r}

#retail$description <- gsub(",","|", retail$description)

item_list <- ddply(retail, c("customer_id","date"), 
                  function(df1)paste(df1$description, 
                                     collapse = ","))
str(item_list)

# remover campos desnecessários
item_list$customer_id <- NULL
item_list$date <- NULL
colnames(item_list) <- c("items")

item_list %>% glimpse

write.csv(item_list,"data/market_basket.csv",
          quote = FALSE, row.names = TRUE)


tr_raw <- read.transactions('data/market_basket.csv', 
                            format = 'basket', sep = ',')
tr
summary(tr_raw)

```


- Preparar a base (sanity tests)
- Quantos produtos?
- Que categorias?
- Quantas compras de volume muito grande?
- Existem preços suspeitos?
- Quantos clientes? Vazios?
- Descritivas
- Quantos produtos por transação?
- Best sellers
- Regras de Associação



## EDA

```{r}

rt_uk %>% 
  mutate(net = quantity * unit_price) %>% 
  group_by(stock_code, description) %>%
  summarise(qty = sum(quantity), net = sum(net)) %>% 
  arrange(desc(net))

```


## PCA

```{r}

pca_prep <- rt_uk %>% 
   group_by(invoice_no,description) %>% 
   summarise(total_quantity = sum(quantity),.groups = "drop") %>% 
   arrange(total_quantity %>% desc()) %>%
   group_by(description) %>%
   mutate(total_quantity_description = sum(total_quantity)) %>% 
   arrange(total_quantity_description %>% desc()) %>% 
   ungroup() %>% 
   select(-total_quantity_description) %>% 
   pivot_wider(names_from = description,
              values_from = total_quantity,
              values_fill = 0) %>% #janitor::clean_names() %>% glimpse()
     select(1:501)

```


```{r}

rec_pca <- recipe( ~ ., data = pca_prep) %>% 
  update_role(invoice_no, new_role = "id") %>% 
  step_normalize(all_predictors()) %>% 
  step_pca(all_predictors(), id = "pca") %>% 
  prep()


tidy_pca <- rec_pca %>% 
  tidy(id = "pca")

```


```{r}

variance_pct <- rec_pca$steps[[2]]$res

(cumsum(variance_pct$sdev^2) / sum(variance_pct$sdev^2))

retail_pca <- juice(rec_pca) %>% glimpse

fviz_eig(variance_pct, addlabels = TRUE) +
  labs(x = "Componente Principal",
       y = "Percentual explicado da variância")

```

# Compomentes principais

```{r include=FALSE}

top_pca <- tidy_pca %>%
  filter(component %in% paste0("PC", 1:6)) %>%
  group_by(component) %>%
  filter(value^2 > mean(value^2)) %>%
  ungroup()
  
top_pca %>% group_by(component) %>% skim()
  
top_pca %>% 
  group_by(component) %>% 
  mutate(terms = reorder_within(terms, abs(value), component)) %>% 
  top_n(10, abs(value)) %>%
  ggplot(aes(abs(value), terms, fill = if_else(value > 0, 'Positiva','Negativa'))) +
  geom_col(size = 0.5) +
  facet_wrap(~component, scales = "free_y") +
  scale_y_reordered() +
  scale_fill_manual(values = c('#4E84C4', '#2d2017')) +
  labs(x = "Valor absoluto da contribuição",
       y = NULL, fill = "Contribuição")

```

## Produtos da missão selecionada

```{r}

products <- top_pca %>% 
  filter(component %in% paste0("PC", 2)) %>% 
  pull(terms)

```


```{r}

rt_mission <-  retail %>% 
  filter(description %in% products) %>%
  mutate(month_year = as.Date(floor_date(date)),
         total_revenue = sum(quantity * unit_price))

```

- quantidade de itens por pedido
- preços outliers
- evolução das compras dos principais produtos
- análise dia da semana/horário
- compras em feriados?
- impacto do sponsorship (ref estudo matéria patrocinada)
- comparar tv x digital
- sem? affiliates?


## Tile map

```{r}

url <- "https://gist.githubusercontent.com/maartenzam/787498bbc07ae06b637447dbd430ea0a/raw/9a9dafafb44d8990f85243a9c7ca349acd3a0d07/worldtilegrid.csv"

countries_raw <- read_csv(url)

countries <- countries_raw %>% 
  rename_all(str_replace_all, "\\.", "_") %>% 
  select(x, y, name, region, alpha_2)

ret_cntry <- countries %>% 
  left_join(rt_summary, by = c("name"="country")) %>% 
  mutate_all(funs(replace_na(., 0)))

```

tilemap - selecionar produtos e ver venda por região

```{r}

mapdata <- get_data_from_map(download_map_data("custom/world")) %>% 
  clean_names()

ret_cntry <- mapdata %>% select(name, hc_a2, code)
  left_join(rt_summary, by = c("name"="country")) %>% 
  mutate_all(funs(replace_na(., 0)))

```


```{r}

hcmap(
  "custom/world",
  data = rt_summary,
  value = "total_revenue",
  joinBy = c("name","country"),
  name = "Sales by Country",
  dataLabels = list(enabled = TRUE, format = "{point.name}"),
  borderColor = "#FAFAFA",
  borderWidth = 0.1,
  tooltip = list(
    valueDecimals = 2,
    valuePrefix = "$",
    valueSuffix = "USD"
  )
)


```


```{r}


data(GNI2014, package = "treemap")

hcmap(
  "custom/world-robinson-lowres", 
  data = rt_summary,
  name = "Total Revenue", 
  value = "total_revenue",
  borderWidth = 0,
  nullColor = "#d3d3d3",
   joinBy = c("name","country"),
  ) %>%
  hc_colorAxis(
    stops = color_stops(colors = viridisLite::inferno(10, begin = 0.1, direction = -1)),
    type = "logarithmic"
    )



?viridisLite::inferno

```




## Evolução

```{r}

library(viridisLite)

prod_list <- c("ALL","SET OF 4 PANTRY JELLY MOULDS", "RECIPE BOX PANTRY YELLOW DESIGN")


selected <- if("ALL" %in% prod_list){products}else{prod_list}

rt_days <- rt_mission %>% 
   mutate(dow = wday(date, label = T, abbr = T),
          full_hour = hour(time),
          holiday = as.factor(holiday)) %>% 
  filter(description %in% selected) %>%
  group_by(dow, full_hour, holiday) %>% 
  summarise(avg_price = sum(unit_price * quantity)/sum(quantity),
            tkts = n_distinct(invoice_no),
            clients = n_distinct(customer_id),
            across(c("quantity", "total_investment", "total_revenue"),
                   ~sum(.x, na.rm = T)))

test_col <- c()

rt_days %>% 
  ggplot(aes(y = clients, x = full_hour, fill = holiday)) +
  geom_col(position = "dodge") +
  facet_wrap(~dow, nrow = 3)


rt_days %>% 
  filter(holiday == 1) %>% 
  ggplot(aes(x = dow, y = full_hour, fill = get(cols_prod$col[1]))) +
  geom_tile() +
  scale_fill_viridis_c(labels = scales::label_number_si()) +
  labs(x = "", y = "Hora", title = "Feriados")
  

rt_days %>% 
  filter(holiday == 0) %>% 
  ggplot(aes(x = dow, y = full_hour, fill = total_revenue)) +
  geom_tile() +
  scale_fill_viridis_c(labels = scales::label_number_si()) + 
  labs(x = "", y = "Hora", title = "Dias normais")
  

rt_days %>% 
  filter(holiday == 0) %>% 
  group_by(dow, full_hour) %>% 
  summarise(sum(total_revenue))
  hchart(., )
  ggplot(aes(x = dow, y = full_hour, fill = total_revenue)) +
  geom_tile() +
  scale_fill_viridis_c(labels = scales::label_number_si()) + 
  labs(x = "", y = "Hora", title = "Feriados")


```



```{r}





```


