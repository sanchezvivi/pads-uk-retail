---
title: "Análise de cesta de Compras"
author: "Debora, Renato, Viviane"
date: "11/14/2020"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: lumen
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(knitr)

library(outliers)
library(ggthemes)
library(skimr)
library(lubridate)
library(janitor)

library(arules)
library(arulesViz)

library(devtools)
library(factoextra)

library(flexdashboard)
library(shiny)
library(highcharter)

library(tidyverse)
library(tidytext)
library(tidymodels)

library(conflicted)



conflict_prefer("filter", "dplyr")
conflict_prefer("mutate", "dplyr")
conflict_prefer("arrange", "dplyr")


today <- Sys.Date()

theme_set(theme_minimal())
theme_update(text = element_text(family = "Open Sans"),
             plot.title = element_text(face = "bold", size = 23,
                                       color = "#1d3752"),
             legend.position = "bottom")

options(digits=4)

```


```{r global, message=FALSE, warning=FALSE, cache=TRUE, context="data", include=FALSE}

### Data

retail_raw <- read_csv("data/retail.csv")

retail <- retail_raw %>% 
  clean_names() %>%
  mutate(description = str_replace(description, ",","|"))

### Processamento


### PCA

pca_prep <- retail %>% 
   group_by(invoice_no,description) %>% 
   summarise(total_quantity = sum(quantity),.groups = "drop") %>% 
   arrange(total_quantity %>% desc()) %>%
   group_by(description) %>%
   mutate(total_quantity_description = sum(total_quantity)) %>% 
   arrange(total_quantity_description %>% desc()) %>% 
   ungroup() %>% 
   select(-total_quantity_description) %>% 
   pivot_wider(names_from = description,
              values_from = total_quantity,
              values_fill = 0) %>% #janitor::clean_names() %>% glimpse()
     select(1:501)

rec_pca <- recipe( ~ ., data = pca_prep) %>% 
  update_role(invoice_no, new_role = "id") %>% 
  step_normalize(all_predictors()) %>% 
  step_pca(all_predictors(), id = "pca") %>% 
  prep()

tidy_pca <- rec_pca %>% 
  tidy(id = "pca")

top_pca <- tidy_pca %>%
  filter(component %in% paste0("PC", 1:6)) %>%
  group_by(component) %>%
  filter(value^2 > mean(value^2)) %>%
  ungroup()

products <- top_pca %>% 
  filter(component %in% paste0("PC", 2)) %>% 
  arrange(desc(value)) %>% 
  pull(terms)

#### 


rt_filter <-  retail %>% 
  filter(description %in% products) %>%
  #filter(description %in% input$prod_id) %>% 
  mutate(month_year = as.Date(floor_date(date)),
         total_revenue = sum(quantity * unit_price)) %>% glimpse

rt_summary <- rt_filter %>% 
  group_by(country) %>% 
  summarise(across(c("quantity", "total_investment", "total_revenue"), ~sum(.x, na.rm = T)),
            across(c("unit_price", "nps"), ~mean(.x, na.rm = T)))


cols <- tibble(col = colnames(rt_summary %>% select(is.numeric)),
               name = c("Quantidade","Investimento Total", "Preço Unitário",
                        "NPS","Receita Total"))

### Basket Analysis

#tr_raw <- read.transactions('data/market_basket.csv', 
#                            format = 'basket', sep = ',')
#

### Recomendação


```


Introdução
=====================================  

```{r echo=FALSE}

#Slide - Como aumentar as vendas?

```

```{r}




```


Análise Geral
=====================================  

Parâmetros {.sidebar}
-----------------------------------------------------------------------

```{r}


```


Row {.tabset}
-----------------------------------------------------------------------

### Gráfico 1


```{r warning=FALSE, context="server"}



```


### Gráfico 2

```{r}


```


### Gráfico 3

```{r}


```


### PCA 

```{r echo=FALSE}

top_pca %>% 
  group_by(component) %>% 
  mutate(terms = reorder_within(terms, abs(value), component)) %>% 
  top_n(10, abs(value)) %>%
  ggplot(aes(abs(value), terms, fill = if_else(value > 0, 'Positiva','Negativa'))) +
  geom_col(size = 0.5) +
  facet_wrap(~component, scales = "free_y", nrow = 3) +
  scale_y_reordered() +
  scale_fill_manual(values = c('#4E84C4', '#2d2017')) +
  labs(x = "Valor absoluto da contribuição",
       y = NULL, fill = "Contribuição") +
  theme(text = element_text(size = 8))

```

Missão
=====================================  

Parâmetros {.sidebar}
-----------------------------------------------------------------------

```{r echo=FALSE}

selectInput("var_id", label = "Variável", choices = cols$name,
            multiple = F,
            selected = "Receita Total")

selectInput("prod_id", label = "Produto", choices = products,
            multiple = T,
            selected = products[1])

actionButton("update_button", "Atualizar")


```


Row {.tabset}
-----------------------------------------------------------------------

### Produtos

```{r echo =FALSE}


plotOutput("sales_line")

```


```{r warning=FALSE, context="server"}

prod_summary <- reactive({
  
  clicks <- input$update_button
  
isolate({  

#prod_summary <- 
  rt_filter %>% 
  filter(description %in% input$prod_id) %>% 
  #filter(description %in% c("12 PENCILS SMALL TUBE SKULL")) %>% 
  group_by(month_year, description) %>% 
  summarise(across(c("quantity", "total_investment", "total_revenue"), ~sum(.x, na.rm = T)),
            across(c("unit_price", "nps"), ~mean(.x, na.rm = T)))


#prod_summary %>% glimpse
  
})})


selected_col <- reactive({
  
    clicks <- input$update_button
  
  isolate({
  
    cols %>% 
      #filter(name == "Quantidade") %>% 
      filter(name == input$var_id) %>% 
      pull(col)
  
})})


output$sales_line <- renderPlot({
  
  clicks <- input$update_button
  
isolate({  
  
  #prod_summary() %>% 
  prod_summary %>% 
    ggplot(aes(x = month_year, 
               #y = selected_col(), 
               y = quantit, 
               color = description)) +
    geom_line() +
    labs(y = input$var_id, x = "")
    
 # prod_summary() %>%  
 #   hchart(., "line", 
 #          hcaes(x = month_year, 
 #                y = selected,
 #                group = description,
 #                y = quantity
 #                )) %>% 
 #   hc_xAxis(title = list(text = "Data")) #%>% hc_yAxis(title = list(text = input$var_id))
  
  })})



```


### Mapa

```{r echo=FALSE}

highchartOutput("sales_map")

```

```{r warning=FALSE, context="server"}

selected_col <- reactive({
  
    clicks <- input$update_button
  
  isolate({
  
    cols %>% 
      #filter(name == "Quantidade") %>% 
      filter(name == input$var_id) %>% 
      pull(col)
  
})})


output$sales_map <- renderHighchart({
  
  clicks <- input$update_button
  
isolate({  
  
  hcmap(
    "custom/world-robinson-lowres", 
    data = rt_summary,
    name = input$var_id, 
    #value = "total_revenue",
    value = selected_col(),
    borderWidth = 0,
    nullColor = "#d3d3d3",
    joinBy = c("name","country")) %>%
  hc_colorAxis(
    stops = color_stops(colors = viridisLite::inferno(10, begin = 0.1, direction = -1)),
    type = "logarithmic") %>% 
  hc_tooltip(valueDecimals = 2)
  
  })})

```

### Gráfico 3

```{r}



```


Regras de Associação
=====================================  

Parâmetros {.sidebar}
-----------------------------------------------------------------------

```{r}

```


Row {.tabset}
-----------------------------------------------------------------------

```{r}

```


Recomendação
=====================================  

Row {.sidebar}
-----------------------------------------------------------------------

### Selecione os produtos

```{r}

```


Row {.tabset}
-----------------------------------------------------------------------

### Resultados

```{r}



```






