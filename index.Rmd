---
title: "Análise de cesta de Compras"
author: "Debora, Renato, Viviane"
date: "11/14/2020"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: lumen
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(knitr)

library(outliers)
library(ggthemes)
library(skimr)
library(lubridate)
library(janitor)

library(arules)
library(arulesViz)

library(devtools)
library(factoextra)

library(flexdashboard)
library(shiny)
library(highcharter)

library(tidyverse)
library(tidytext)
library(tidymodels)

library(conflicted)



conflict_prefer("filter", "dplyr")
conflict_prefer("mutate", "dplyr")
conflict_prefer("arrange", "dplyr")
conflict_prefer("pivot_longer", "dplyr")
conflict_prefer("starts_with", "dplyr")
conflict_prefer("select", "dplyr")


today <- Sys.Date()

theme_set(theme_minimal())
theme_update(text = element_text(family = "Open Sans"),
             plot.title = element_text(face = "bold", size = 18,
                                       color = "#1d3752"),
             legend.position = "bottom")

options(digits=4)

hc_cols <- c("#7cb5ec", "#434348", "#90ed7d", "#f7a35c", 
             "#8085e9", "#f15c80", "#e4d354", "#2b908f", 
             "#f45b5b", "#91e8e1")

```


```{r global, message=FALSE, warning=FALSE, cache=TRUE, context="data", include=FALSE}

### Data

retail_raw <- read_csv("data/retail.csv")

retail <- retail_raw %>% 
  clean_names() %>%
  mutate(description = str_replace(description, ",","|")) %>% 
  mutate(month_year = as.Date(floor_date(date)),
         total_revenue = quantity * unit_price)

### Processamento

rt_summary <- retail %>%
  group_by(country) %>% 
  summarise(across(c("quantity", "total_investment", "total_revenue"),
                   ~sum(.x, na.rm = T)),
            across(c("unit_price", "nps"), ~mean(.x, na.rm = T)),
            tkts = n_distinct(invoice_no)) %>% 
  mutate(perc_net = round(total_revenue*100/sum(total_revenue),1),
         perc_tkts = round(tkts*100/sum(tkts),1)) %>% 
  arrange(desc(total_revenue))

cols_map <- tibble(col = colnames(rt_summary %>% 
                                    select(where(is.numeric)) %>% 
                                    select(-starts_with("perc"))),
               name = c("Quantidade","Investimento Total","Receita Total", "Preço Unitário",
                        "NPS", "Ticket"))



### Análise UK


group_tb <- tibble(group_name = c("Pedido", "Cliente", "Produto"),
                   col_name = c("invoice_no", "customer_id","description"))

tickets <- retail %>% 
  filter(country == "United Kingdom") %>% 
  group_by(invoice_no) %>%
  summarise(Quantidade = sum(quantity), Receita = sum(total_revenue)) %>% 
  arrange(desc(Receita))

foras <- tickets %>% 
  filter(Receita > 50000) %>%
  select(invoice_no) %>% unique() %>% 
  pull(invoice_no)

clientes <- retail %>% 
  group_by(customer_id,invoice_no) %>%
  summarise(Tkt = length(unique(invoice_no)) ,Qty = sum(quantity), Net = sum(total_revenue)) %>%
  group_by(customer_id) %>%
  summarise(Tkt = sum(Tkt) ,Qty = sum(Qty), Net = sum(Net)) %>%
  arrange(desc(Net))

foras2 <- clientes %>% 
  filter(Tkt > 100) %>% 
  pull(customer_id)

rt_uk <- retail %>% 
  filter(country == "United Kingdom") %>% 
  filter(!invoice_no %in% foras) %>% 
  filter(!customer_id %in% foras2)


### PCA

pca_prep <- rt_uk %>% 
   group_by(invoice_no,description) %>% 
   summarise(total_quantity = sum(quantity),.groups = "drop") %>% 
   arrange(total_quantity %>% desc()) %>%
   group_by(description) %>%
   mutate(total_quantity_description = sum(total_quantity)) %>% 
   arrange(total_quantity_description %>% desc()) %>% 
   ungroup() %>% 
   select(-total_quantity_description) %>% 
   pivot_wider(names_from = description,
              values_from = total_quantity,
              values_fill = 0) %>% #janitor::clean_names() %>% glimpse()
     select(1:501)

rec_pca <- recipe( ~ ., data = pca_prep) %>% 
  update_role(invoice_no, new_role = "id") %>% 
  step_normalize(all_predictors()) %>% 
  step_pca(all_predictors(), id = "pca") %>% 
  prep()

tidy_pca <- rec_pca %>% 
  tidy(id = "pca")

top_pca <- tidy_pca %>%
  filter(component %in% paste0("PC", 1:6)) %>%
  group_by(component) %>%
  filter(value^2 > mean(value^2)) %>%
  ungroup()

products <- top_pca %>% 
  filter(component %in% paste0("PC", 2)) %>% 
  arrange(desc(value)) %>% 
  pull(terms)

#### 

rt_filter <-  retail %>% 
  filter(description %in% products) %>%
  mutate(month_year = as.Date(floor_date(date)),
         total_revenue = sum(quantity * unit_price))

### Basket Analysis

#tr_raw <- read.transactions('data/market_basket.csv', 
#                            format = 'basket', sep = ',')
#

### Recomendação




```


Introdução
=====================================  

```{r echo=FALSE}

#Slide - Como aumentar as vendas?

```

```{r}





```


Análise Geral
=====================================  

Parâmetros {.sidebar}
-----------------------------------------------------------------------

```{r echo = FALSE}

selectInput("var_id", label = "Variável", choices = cols_map$name,
            multiple = F,
            selected = "Receita Total")

selectInput("group_id", label = "Agrupamento", choices = group_tb$group_name,
            multiple = F,
            selected = "Pedido")


actionButton("update_button", "Atualizar")


```


Row {.tabset}
-----------------------------------------------------------------------

### Mapa Geral

```{r echo=FALSE}

highchartOutput("sales_map")

```

```{r warning=FALSE, context="server"}

selected_col <- reactive({
  
    clicks <- input$update_button
  
  isolate({
  
    cols_map %>% 
      #filter(name == "Quantidade") %>% 
      filter(name == input$var_id) %>% 
      pull(col)
  
})})

output$sales_map <- renderHighchart({
  
  clicks <- input$update_button
  
isolate({  
  
  hcmap(
    "custom/world-robinson-lowres", 
    data = rt_summary,
    name = input$var_id, 
    #value = "total_revenue",
    value = selected_col(),
    borderWidth = 0,
    nullColor = "#d3d3d3",
    joinBy = c("name","country")) %>%
  hc_colorAxis(
    stops = color_stops(colors = viridisLite::inferno(10, begin = 0.1, direction = -1)),
    type = "logarithmic") %>% 
  hc_tooltip(valueDecimals = 2)
  
  })})

```

### Faturamento e Transações por país

```{r echo = FALSE}

#highchartOutput("sales_pct")
#
#```
#
#```{r warning=FALSE, context="server"}
#
#output$sales_line <- renderHighchart({
  
  rt_summary %>%  
    select(country, starts_with("perc")) %>% 
    pivot_longer(cols = starts_with("perc"),
                 names_prefix = "perc_",
                 names_to = "variable",
                 values_to = "pct") %>% 
    mutate(variable = if_else(variable == "net","Faturamento", "Transações")) %>% 
    hchart(., "column", 
           hcaes(x = country, #reorder(country,desc(perc_net)), 
                 y = pct,
                 group = variable)) %>% 
    hc_xAxis(title = list(text = "País")) %>% 
    hc_yAxis(title = list(text = ""),
               labels = list(format = "{value}%"))
  
 # })

```

### Vendas por produto

```{r echo=FALSE}

renderTable({

rt_uk %>% 
  group_by(description) %>%
  summarise(Quantidade = sum(quantity), Receita = sum(total_revenue)) %>% 
  arrange(desc(Receita)) #%>% kable()

})  

```


### Distribuição por transação

```{r echo = FALSE}

plotOutput("histogram")

```


```{r warning=FALSE, context="server"}

selected_group <- reactive({
  
    clicks <- input$update_button
  
  isolate({
  
    group_tb %>% 
      #filter(name == "Quantidade") %>% 
      filter(group_name == input$group_id) %>% 
      pull(col_name)
  
})})


output$histogram <- renderPlot({
  
#  clicks <- input$update_button
#  
#isolate({ 
#
#  retail %>% 
#    filter(country == "United Kingdom") %>% 
#    group_by(selected_group()) %>% 
#    summarise(Total = sum(select_col())) %>% 
#      ggplot(aes(x = Total)) + 
#      geom_histogram(binwidth = 50) + 
#      coord_cartesian(xlim = c(0, 2000))+
#      geom_vline(aes(xintercept=median(Total)),
#                color = hc_cols[1], linetype="dashed", size=1)+
#      geom_vline(aes(xintercept=mean(Total)),
#                color="red", linetype="dashed", size=1) +
#      labs(title = "Produtos por transação", x = "Quantidade de produtos", y = "")
    

tickets %>% 
   pivot_longer(cols = c("Quantidade","Receita"),
                names_to = "variable",
                values_to = "value") %>% 
   group_by(variable) %>% 
gplot(aes(x=value)) + 
 geom_histogram(binwidth=50) + 
 coord_cartesian(xlim = c(0, 2000))+
 geom_vline(aes(xintercept=median(value)),
           color = hc_cols[1], linetype="dashed", size=1)+
 geom_vline(aes(xintercept=mean(value)),
           color="red", linetype="dashed", size=1) +
   facet_wrap(~variable, nrow = 2, scales = "free_y") +
 labs(title = "Produtos por transação", x = "Quantidade de produtos", y = "")
 
})
#})

```


### Preços


```{r}



```

```{r warning=FALSE, context="server"}

selected_col <- reactive({
  
    clicks <- input$update_button
  
  isolate({
  
    cols_map %>% 
      #filter(name == "Quantidade") %>% 
      filter(name == input$var_id) %>% 
      pull(col)
  
})})

output$sales_map <- renderHighchart({
  
  clicks <- input$update_button
  
isolate({ 
  
retail %>% 
ggplot(aes(x = unit_price)) + 
  geom_histogram(binwidth = 1) + coord_cartesian(xlim = c(0, 20))+
  geom_vline(aes(xintercept=median(unit_price)),
            color="blue", linetype="dashed", size=1)+
   geom_vline(aes(xintercept=mean(unit_price)),
            color="red", linetype="dashed", size=1)+
  theme_economist()+
  labs(title = "Preço por Produto",x = "Preco", y = "Produto")

})})
 
```


### PCA 

```{r echo=FALSE}

top_pca %>% 
  group_by(component) %>% 
  mutate(terms = reorder_within(terms, abs(value), component)) %>% 
  top_n(10, abs(value)) %>%
  ggplot(aes(abs(value), terms, fill = if_else(value > 0, 'Positiva','Negativa'))) +
  geom_col(size = 0.5) +
  facet_wrap(~component, scales = "free_y", nrow = 3) +
  scale_y_reordered() +
  scale_fill_manual(values = c('#4E84C4', '#2d2017')) +
  labs(x = "Valor absoluto da contribuição",
       y = NULL, fill = "Contribuição") +
  theme(text = element_text(size = 8))

```

Missão
=====================================  

Parâmetros {.sidebar}
-----------------------------------------------------------------------

```{r echo=FALSE}

selectInput("var_id", label = "Variável", choices = cols_map$name,
            multiple = F,
            selected = "Receita Total")

selectInput("prod_id", label = "Produto", choices = products,
            multiple = T,
            selected = products[1])

actionButton("update_button", "Atualizar")


```


Row {.tabset}
-----------------------------------------------------------------------

### Produtos

```{r echo =FALSE}


plotOutput("sales_line")

```


```{r warning=FALSE, context="server"}

prod_summary <- reactive({
  
  clicks <- input$update_button
  
isolate({  

#prod_summary <- 
  rt_filter %>% 
  filter(description %in% input$prod_id) %>% 
  #filter(description %in% c("12 PENCILS SMALL TUBE SKULL")) %>% 
  group_by(month_year, description) %>% 
  summarise(across(c("quantity", "total_investment", "total_revenue"), ~sum(.x, na.rm = T)),
            across(c("unit_price", "nps"), ~mean(.x, na.rm = T)))


#prod_summary %>% glimpse
  
})})


selected_col <- reactive({
  
    clicks <- input$update_button
  
  isolate({
  
    cols_map %>% 
      #filter(name == "Quantidade") %>% 
      filter(name == input$var_id) %>% 
      pull(col)
  
})})


output$sales_line <- renderPlot({
  
  clicks <- input$update_button
  
isolate({  
  
  #prod_summary() %>% 
  prod_summary %>% 
    ggplot(aes(x = month_year, 
               #y = selected_col(), 
               y = quantity, 
               color = description)) +
    geom_line() +
    labs(y = input$var_id, x = "")
    
 # prod_summary() %>%  
 #   hchart(., "line", 
 #          hcaes(x = month_year, 
 #                y = selected,
 #                group = description,
 #                y = quantity
 #                )) %>% 
 #   hc_xAxis(title = list(text = "Data")) #%>% hc_yAxis(title = list(text = input$var_id))
  
  })})



```


Regras de Associação
=====================================  

Parâmetros {.sidebar}
-----------------------------------------------------------------------

```{r}

```


Row {.tabset}
-----------------------------------------------------------------------

```{r}

```


Recomendação
=====================================  

Row {.sidebar}
-----------------------------------------------------------------------

### Selecione os produtos

```{r}

```


Row {.tabset}
-----------------------------------------------------------------------

### Resultados

```{r}



```






